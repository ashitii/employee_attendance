{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'logo.png' %}">
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      {% block title %}
        Dashboard
      {% endblock %}
    </title>

    <!-- Bootstrap & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <!-- Custom CSS: Split for maintainability -->

    <link rel="stylesheet" href="{% static 'attendance/css/style.css' %}" />
  </head>
  <body>
    <!-- Loading Spinner Overlay with Rotating Logo -->
    <div id="loading-overlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.85);z-index:2000;display:flex;align-items:center;justify-content:center;transition:opacity 0.3s;">
      <div class="d-flex flex-column align-items-center">
        <img src="{% static 'logo.png' %}" alt="Logo" style="width:80px;height:80px;animation:spin 1.2s linear infinite;border-radius:50%;object-fit:cover;">
        <span class="mt-3 fw-bold" id="loading-text" style="color:#0e0e52;font-size:1.2rem;">Loading...</span>
      </div>
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      @media (prefers-color-scheme: dark) {
        #loading-overlay {
          background: rgba(20, 20, 30, 0.92) !important;
        }
        #loading-text {
          color: #e0e6ff !important;
        }
      }
    </style>

    <!-- Navbar -->
    <nav class="navbar">
      <button id="sidebarToggle" class="btn-toggle-sidebar" aria-label="Toggle sidebar"><i class="bi bi-list"></i></button>
      <a href="#" class="navbar-brand">Zynova Solutions</a>

      <div class="ms-auto d-flex align-items-center">
        {% if user.is_authenticated %}
          <!-- Notification Bell -->
          <div class="nav-item dropdown mx-3">
            <a href="#" id="notifBell" class="nav-link position-relative" onclick="toggleNotifications(event)">
              <i class="bi bi-bell"></i>
              <span class="badge bg-danger rounded-pill" id="notif-count">{{ unread_notifications_count|default:'0' }}</span>
            </a>
            <div id="notif-menu" class="dropdown-menu dropdown-menu-end p-2 shadow" style="min-width: 300px; display: none;">
              <p class="dropdown-item text-center mb-0">Loading notifications...</p>
            </div>
          </div>

          <!-- Profile Dropdown -->
          <div class="dropdown">
            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">{{ user.first_name|default:user.username|default:'User' }}</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="{% url 'edit_profile' %}">Edit Profile</a>
              </li>
              <li>
                <a class="dropdown-item" href="{% url 'logout' %}">Logout</a>
              </li>
            </ul>
          </div>
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-outline-light btn-sm">Login</a>
        {% endif %}
      </div>
    </nav>

    <!-- Sidebar -->
    <div id="sidebar" role="navigation" aria-label="Main sidebar navigation">
      <ul class="nav flex-column">
        {% if user.is_authenticated %}
          {% with role=user.groups.all.0.name %}
            {% if role == 'Admin' %}
              <li class="nav-item">
                <a href="{% url 'admin_dashboard' %}" class="nav-link {% if request.path == '/dashboard/' %}active{% endif %}"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'view_leave_requests' %}" class="nav-link {% if request.path == '/view_leave_requests/' %}active{% endif %}"><i class="bi bi-file-earmark-text"></i><span>Leave Requests</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'holiday_list' %}" class="nav-link {% if request.path == '/holiday_list/' %}active{% endif %}"><i class="bi bi-journal-text"></i><span>Holiday List</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'calendar' %}" class="nav-link {% if request.path == '/calendar/' %}active{% endif %}"><i class="fa fa-calendar" style="font-size:20px;"></i><span>Calendar</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'manage_notices' %}" class="nav-link {% if request.path == '/manage_notices/' %}active{% endif %}"><i class="bi bi-megaphone"></i><span>Manage Notices</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'chat_home' %}" class="nav-link {% if request.path == '/chat/' %}active{% endif %}"><i class="bi bi-chat-dots"></i><span>Chat</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'monthly_attendance' %}" class="nav-link {% if request.path == '/monthly-attendance/' %}active{% endif %}"><i class="bi bi-calendar-check"></i><span>Monthly Attendance</span></a>
              </li>
            {% elif role == 'Manager' %}
              <li class="nav-item">
                <a href="{% url 'manager_dashboard' %}" class="nav-link {% if request.path == '/manager_dashboard/' %}active{% endif %}"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'view_leave_requests' %}" class="nav-link {% if request.path == '/view_leave_requests/' %}active{% endif %}"><i class="bi bi-file-earmark-text"></i><span>Leave Requests</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'leave_dashboard' %}" class="nav-link {% if request.path == '/leave_dashboard/' %}active{% endif %}"><i class="bi bi-file-earmark-plus"></i><span>Apply Leave</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'calendar' %}" class="nav-link {% if request.path == '/calendar/' %}active{% endif %}"><i class="bi bi-file-earmark-text"></i><span>Calendar</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'holiday_list' %}" class="nav-link {% if request.path == '/holiday_list/' %}active{% endif %}"><i class="bi bi-journal-text"></i><span>Holiday List</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'chat_home' %}" class="nav-link {% if request.path == '/chat/' %}active{% endif %}"><i class="bi bi-chat-dots"></i><span>Chat</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'monthly_attendance' %}" class="nav-link {% if request.path == '/monthly-attendance/' %}active{% endif %}"><i class="bi bi-calendar-check"></i><span>Monthly Attendance</span></a>
              </li>
            {% elif role == 'Employee' %}
              <li class="nav-item">
                <a href="{% url 'employee_dashboard' %}" class="nav-link {% if request.path == '/employee_dashboard/' %}active{% endif %}"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'leave_dashboard' %}" class="nav-link {% if request.path == '/leave_dashboard/' %}active{% endif %}"><i class="bi bi-file-earmark-plus"></i><span>Apply Leave</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'calendar' %}" class="nav-link {% if request.path == '/calendar/' %}active{% endif %}"><i class="bi bi-file-earmark-text"></i><span>Calendar</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'holiday_list' %}" class="nav-link {% if request.path == '/holiday_list/' %}active{% endif %}"><i class="bi bi-journal-text"></i><span>Holiday List</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'chat_home' %}" class="nav-link {% if request.path == '/chat/' %}active{% endif %}"><i class="bi bi-chat-dots"></i><span>Chat</span></a>
              </li>
              <li class="nav-item">
                <a href="{% url 'monthly_attendance' %}" class="nav-link {% if request.path == '/monthly-attendance/' %}active{% endif %}"><i class="bi bi-calendar-check"></i><span>Monthly Attendance</span></a>
              </li>
            {% endif %}
          {% endwith %}
        {% endif %}
      </ul>
    </div>

    <!-- Main Content -->
    <main id="content" class="wrapper content-area flex-grow-1 bg-light d-flex flex-column">
      <div class="container m-2 p-4">
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}

        {% block content %}

        {% endblock %}
      </div>
    </main>

    <!-- Bootstrap Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Sidebar Toggle -->
    <script>
      function handleSidebarToggle(e) {
        e.preventDefault();
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        const content = document.getElementById('content');
        if (window.innerWidth <= 992) {
          const isActive = sidebar.classList.toggle('active');
          if (overlay) overlay.style.display = isActive ? 'block' : 'none';
        } else {
          sidebar.classList.toggle('collapsed');
          content.classList.toggle('collapsed');
        }
      }
      document.addEventListener('DOMContentLoaded', function() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', handleSidebarToggle);
        }
        // Hide sidebar when overlay is clicked (for mobile)
        const overlay = document.querySelector('.sidebar-overlay');
        const sidebar = document.getElementById('sidebar');
        if (overlay) {
          overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.style.display = 'none';
          });
        }
      });

      // Hide sidebar when overlay is clicked (for mobile)
      document.addEventListener('DOMContentLoaded', function() {
        const overlay = document.querySelector('.sidebar-overlay');
        const sidebar = document.getElementById('sidebar');
        if (overlay) {
          overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.style.display = 'none';
          });
        }
      });
      function toggleNotifications(event) {
        event.preventDefault()
        const menu = document.getElementById('notif-menu')
        if (menu.style.display === 'block') {
          menu.style.display = 'none'
          return
        }
        menu.style.display = 'block'
        fetch('/notifications/ajax/')
          .then((res) => res.json())
          .then((data) => {
            const countBadge = document.getElementById('notif-count')
            menu.innerHTML = ''
            if (data.notifications.length > 0) {
              countBadge.innerText = data.notifications.length
              data.notifications.forEach((n) => {
                const a = document.createElement('a')
                a.href = n.url || '#'
                a.className = 'dropdown-item'
                a.textContent = `${n.message} (${n.timestamp})`
                menu.appendChild(a)
              })
            } else {
              countBadge.innerText = '0'
              const p = document.createElement('p')
              p.className = 'dropdown-item text-center mb-0'
              p.textContent = 'No notifications'
              menu.appendChild(p)
            }
          })
          .catch(() => {
            menu.innerHTML = '<p class="dropdown-item text-center text-danger mb-0">Failed to load notifications</p>'
          })
      }
      
      document.addEventListener('click', (e) => {
        const notifBell = document.getElementById('notifBell')
        const menu = document.getElementById('notif-menu')
        if (!notifBell.contains(e.target) && !menu.contains(e.target)) {
          menu.style.display = 'none'
        }
      })
      
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.alert:not(.static-birthday)').forEach((alert) => {
          setTimeout(() => {
            const instance = bootstrap.Alert.getOrCreateInstance(alert)
            instance.close()
          }, 3000)
        })
      })

      // Hide loading overlay when page is fully loaded (with 3s delay for testing)
      window.addEventListener('load', function() {
        setTimeout(function() {
          document.getElementById('loading-overlay').style.opacity = 0;
          setTimeout(function() {
            document.getElementById('loading-overlay').style.display = 'none';
          }, 300);
        }); // 3 seconds delay
      });
    </script>
  </body>
</html>
